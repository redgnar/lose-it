# API Endpoint Implementation Plan: Create Recipe

## 1. Endpoint Overview
This endpoint allows authenticated users to create a new recipe. Upon creation, the system initializes the recipe metadata, creates the first "original" version, and populates it with ingredients and steps parsed from raw text.

## 2. Request Details
- HTTP Method: `POST`
- URL Structure: `/api/recipes`
- Parameters:
    - Required:
        - `title`: String (1-255 chars)
        - `raw_ingredients`: String (newline-separated list)
        - `raw_steps`: String (newline or numbered list)
        - `servings`: Integer (1-12)
- Request Body:
```json
{
  "title": "Spaghetti Carbonara",
  "raw_ingredients": "200g Pasta\n2 Eggs\n50g Guanciale",
  "raw_steps": "1. Boil water\n2. Cook pasta",
  "servings": 2
}
```

## 3. Used Types
- **Ux Layer (DTOs):**
    - `App\Ux\Http\Recipe\CreateRecipe\CreateRecipeCommandDto`: Request payload mapping and validation.
    - `App\Ux\Http\Recipe\RecipeDetail\Dto\RecipeResponseDto`: Response payload for the created recipe.
- **Application Layer (Commands/Handlers/DTOs):**
    - `App\Application\Command\CreateRecipe\CreateRecipeCommand`: Internal command carrying validated data.
    - `App\Application\Command\CreateRecipe\CreateRecipeCommandHandler`: Orchestrates the creation logic.
    - `App\Application\Dto\RecipeDetailDto`: Return data from the handler.
- **Domain Layer:**
    - `App\Domain\Enum\Servings`: Enum for servings (1-12).
- **Infrastructure Layer (Entities):**
    - `App\Infrastructure\Doctrine\Entity\Recipe`
    - `App\Infrastructure\Doctrine\Entity\RecipeVersion`
    - `App\Infrastructure\Doctrine\Entity\RecipeIngredient`

## 4. Response Details
- **Success (201 Created):**
```json
{
  "id": "uuid",
  "title": "Spaghetti Carbonara",
  "is_favorite": false,
  "version_id": "uuid",
  "servings": 2,
  "ingredients": [
    { "original_text": "200g Pasta", "is_parsed": false },
    { "original_text": "2 Eggs", "is_parsed": false }
  ],
  "steps": ["1. Boil water", "2. Cook pasta"],
  "total_calories": null,
  "calories_per_serving": null,
  "calorie_confidence": null
}
```
- **Error (400 Bad Request):** Validation errors (e.g., empty title, invalid servings).
- **Error (401 Unauthorized):** User not authenticated.

## 5. Data Flow
1. `CreateRecipeController` receives the JSON payload.
2. `MapRequestPayload` hydrates `CreateRecipeCommandDto` and performs validation.
3. Controller retrieves the current `User` from security context.
4. Controller maps DTO and User to `CreateRecipeCommand` and passes it to `CreateRecipeCommandHandler`.
5. `CreateRecipeCommandHandler` starts a database transaction:
    - Creates `Recipe` entity.
    - Creates `RecipeVersion` with `tailoring_type = 'original'`.
    - Parses `raw_ingredients` string by newlines, creating `RecipeIngredient` for each line.
    - Parses `raw_steps` string into an array of strings for the JSON `steps` field.
    - Updates `Recipe.searchText` with title and ingredient names (for FULLTEXT search).
    - Flushes changes via `EntityManager`.
6. Handler returns `RecipeDetailDto`.
7. Controller returns `201 Created` with `RecipeResponseDto`.

## 6. Security Considerations
- **Authentication**: Endpoint must be protected by Symfony Security (Google OAuth).
- **Authorization**: The recipe is automatically linked to the currently authenticated user.
- **Input Sanitization**: `title`, `raw_ingredients`, and `raw_steps` should be trimmed. Raw HTML tags should be stripped or escaped if necessary (handled by Twig on output, but good to sanitize on input).

## 7. Error Handling
- **Validation Errors**: Symfony Validator will catch invalid servings or empty fields, returning 400.
- **Database Errors**: Wrapped in 500 Internal Server Error (logged).
- **Unauthenticated**: Handled by Symfony Security (401).

## 8. Performance Considerations
- **Search Text**: The `searchText` column is updated synchronously. While this adds a small overhead to creation, it ensures immediate searchability.
- **Atomic Inserts**: All related entities (`Recipe`, `RecipeVersion`, `RecipeIngredients`) are saved in a single transaction.

## 9. Implementation Steps
1. **Ux Layer**:
    - Update `CreateRecipeCommandDto` with Symfony Validator attributes (`#[Assert\NotBlank]`, `#[Assert\Range]`).
    - Create `CreateRecipeController` in `App\Ux\Http\Recipe\CreateRecipe`.
2. **Application Layer**:
    - Implement `CreateRecipeCommandHandler`.
    - Create `RecipeDetailDto` if not exists.
3. **Infrastructure Layer**:
    - Ensure `RecipeRepository` and others are ready.
4. **Testing**:
    - Create a functional test `app/tests/Api/Recipe/CreateRecipeTest.php` following GIVEN/WHEN/THEN.
    - Verify 201 response and DB persistence.
