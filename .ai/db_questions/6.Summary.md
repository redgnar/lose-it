<conversation_summary>
<decisions>
1. MariaDB is the selected database system, with security enforced at the Application layer using Symfony Security and Doctrine Filters.
2. The `Recipe` entity acts as a performant "current state" container, holding redundant copies of all fields from the active `RecipeVersion` to eliminate JOINs for primary read paths.
3. `RecipeVersion` is immutable, storing historical states (ingredients, steps, servings) and a `parent_version_id` to support multi-step "Undo" functionality.
4. Ingredients are stored as structured `RecipeIngredient` line-items linked to `RecipeVersion`, using `DECIMAL(12, 4)` for high-precision scaling.
5. Cooking steps are stored as a `JSON` column in `RecipeVersion` with `JSON_VALID()` constraints to allow for future metadata expansion (e.g., timers).
6. A global `IngredientRegistry` handles normalization with a `visibility` flag (Global/Private) and an `is_verified` status for nutritional data accuracy.
7. The `avoid_list` is implemented as a many-to-many relationship between `UserPreference` and the `IngredientRegistry`.
8. MariaDB `FULLTEXT` indexing is used on a denormalized `search_text` column that is synchronously updated with title and ingredient data.
9. Data retention for the `Events` table uses MariaDB Table Partitioning by range (monthly) to facilitate efficient 90-day cleanup.
10. `TailoringQuota` enforcement uses an atomic `UPDATE` strategy with `IF()` logic to handle lazy resets and concurrency without cron-heavy background tasks.
11. `ON DELETE CASCADE` is applied to all user-owned records, while `Events` records are anonymized (nullify `user_id`) to preserve analytics during account deletion.
12. Metric/US unit conversions are handled via a `UnitRegistry` and `UnitConversion` table, preserving the `original_quantity` to avoid destructive rounding.
    </decisions>

<matched_recommendations>
1. Recommendation: Use MariaDB `JSON` with `JSON_VALID()` for flexible but validated step storage.
2. Recommendation: Implement a many-to-many relationship for `avoid_list` to maintain relational integrity.
3. Recommendation: Denormalize `RecipeVersion` content into the `Recipe` entity for P95 read performance.
4. Recommendation: Use `DECIMAL(12, 4)` for ingredient quantities to ensure deterministic scaling.
5. Recommendation: Synchronously update a `FULLTEXT` search index to ensure immediate consistency.
6. Recommendation: Use `parent_version_id` for a branching version history to support "Undo".
7. Recommendation: Use Table Partitioning for high-volume event logs with time-based retention.
8. Recommendation: Implement atomic quota resets using conditional SQL updates.
9. Recommendation: Use a `visibility` and `is_verified` flag system for the `IngredientRegistry`.
10. Recommendation: Store non-scalable items like "salt to taste" with an `is_scalable` flag.
    </matched_recommendations>

<database_planning_summary>
The database architecture for **Lose It!** is designed for high read performance and deterministic accuracy. By utilizing MariaDB as the core engine, the schema balances relational rigor with the flexibility of JSON for semi-structured data like recipe steps.

**Main Requirements:**
- **Performance:** The "Redundant Recipe" pattern ensures that the most frequent user action (viewing a recipe) is a single-table lookup.
- **Accuracy:** Precise math is guaranteed via `DECIMAL` types and a robust `UnitRegistry` with conversion factors.
- **Traceability:** Every tailoring action creates an immutable `RecipeVersion` linked in a parent-child chain, enabling complex "Undo" operations.

**Key Entities and Relationships:**
- **User & Preference:** One-to-one link to dietary preferences and unit systems.
- **Recipe & RecipeVersion:** One-to-many relationship where `Recipe` mirrors the "active" version's state.
- **IngredientRegistry & UnitRegistry:** Global reference tables for normalization and nutritional verification.
- **Substitutions:** A logging table linking original ingredients to AI-proposed alternatives for historical tracking.

**Security and Scalability:**
- **App-Layer Isolation:** Symfony Security and Doctrine Filters prevent cross-user data leakage.
- **Scalable Cleanup:** Partitioned event logs ensure the database doesn't bloat over time, allowing for instant removal of data older than 90 days.
- **Concurrency Control:** Atomic quota updates prevent users from bypassing AI limits during high-load periods.
  </database_planning_summary>

<unresolved_issues>
1. **Nutritional Data Source:** The specific structure for storing external API nutritional IDs (e.g., USDA/Edamam) within the `IngredientRegistry` is yet to be defined.
2. **Media Storage:** The schema currently focuses on text/data; a strategy for linking images to `Recipe` or `RecipeVersion` (e.g., S3 URLs) needs to be finalized.
3. **AI Prompt Versioning:** While recipe content is versioned, the specific AI prompts used to generate those versions are not currently tracked in the schema.
   </unresolved_issues>
   </conversation_summary>